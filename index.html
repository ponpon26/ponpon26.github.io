<!doctype html>
<html lang="th" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Safe Space</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&amp;family=Caveat:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
html, body { height: 100%; margin: 0; padding: 0; }
body { font-family: 'Quicksand', 'Noto Sans Thai', sans-serif; overflow: hidden; }
* { box-sizing: border-box; }
:root {
  --bg-gradient-1: #fce4f2;
  --bg-gradient-2: #dbeafe;
  --bg-gradient-3: #f0e6ff;
  --card-bg: #ffffff;
  --text-primary: #4a3560;
  --text-secondary: #7c6c8a;
  --accent-pink: #f9a8d4;
  --accent-blue: #93c5fd;
  --accent-purple: #c4b5fd;
  --btn-primary: linear-gradient(135deg, #f9a8d4, #93c5fd);
  --btn-hover: linear-gradient(135deg, #f472b6, #60a5fa);
}
.app-wrapper {
  width: 100%; height: 100%;
  background: linear-gradient(160deg, var(--bg-gradient-1) 0%, var(--bg-gradient-2) 50%, var(--bg-gradient-3) 100%);
  overflow-y: auto; overflow-x: hidden;
  position: relative;
}
.cloud {
  position: fixed; opacity: 0.3; pointer-events: none; z-index: 0;
  animation: floatCloud 20s ease-in-out infinite;
}
.cloud:nth-child(2) { animation-delay: -5s; animation-duration: 25s; }
.cloud:nth-child(3) { animation-delay: -10s; animation-duration: 30s; }
@keyframes floatCloud {
  0%, 100% { transform: translateX(0) translateY(0); }
  25% { transform: translateX(20px) translateY(-10px); }
  50% { transform: translateX(-10px) translateY(5px); }
  75% { transform: translateX(15px) translateY(-5px); }
}
.paper-rocket {
  position: fixed; opacity: 0.15; pointer-events: none; z-index: 0;
  animation: rocketFloat 15s ease-in-out infinite;
}
@keyframes rocketFloat {
  0%, 100% { transform: translateY(0) rotate(-10deg); }
  50% { transform: translateY(-30px) rotate(10deg); }
}
.glass-card {
  background: rgba(255,255,255,0.75);
  backdrop-filter: blur(12px);
  border: 1px solid rgba(255,255,255,0.5);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(147,100,200,0.1);
}
.btn-gradient {
  background: var(--btn-primary);
  color: white; border: none; border-radius: 14px;
  font-weight: 600; cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(249,168,212,0.3);
  font-family: 'Quicksand', 'Noto Sans Thai', sans-serif;
}
.btn-gradient:hover {
  background: var(--btn-hover);
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(249,168,212,0.4);
}
.btn-gradient:disabled {
  opacity: 0.5; cursor: not-allowed; transform: none;
}
.page { display: none; width: 100%; height: 100%; position: relative; z-index: 1; }
.page.active { display: flex; flex-direction: column; }
.input-field {
  width: 100%; padding: 12px 16px;
  border: 2px solid rgba(196,181,253,0.3);
  border-radius: 12px; background: rgba(255,255,255,0.6);
  font-family: 'Quicksand', 'Noto Sans Thai', sans-serif; font-size: 14px;
  color: var(--text-primary); outline: none;
  transition: border-color 0.3s;
}
.input-field:focus { border-color: var(--accent-pink); }
.bottom-nav {
  display: flex; justify-content: space-around; align-items: center;
  padding: 8px 0; background: rgba(255,255,255,0.85);
  backdrop-filter: blur(10px); border-top: 1px solid rgba(196,181,253,0.2);
  position: sticky; bottom: 0; z-index: 10; flex-shrink: 0;
}
.nav-item {
  display: flex; flex-direction: column; align-items: center;
  cursor: pointer; padding: 4px 8px; transition: all 0.2s;
  color: var(--text-secondary); font-size: 10px; gap: 2px;
}
.nav-item.active { color: #ec4899; }
.nav-item svg { width: 24px; height: 24px; }
.banner-slide {
  display: flex; align-items: center; justify-content: center;
  min-width: 100%; height: 100%; padding: 16px;
  font-family: 'Caveat', cursive; font-size: 22px;
  color: var(--text-primary); text-align: center;
}
.banner-container {
  overflow: hidden; border-radius: 16px;
  background: linear-gradient(135deg, rgba(249,168,212,0.2), rgba(147,197,253,0.2));
  height: 80px; position: relative;
}
.banner-track {
  display: flex; transition: transform 0.6s ease;
  height: 100%;
}
.feature-card {
  background: rgba(255,255,255,0.7); backdrop-filter: blur(8px);
  border: 1px solid rgba(255,255,255,0.5); border-radius: 16px;
  padding: 20px; cursor: pointer; transition: all 0.3s;
}
.feature-card:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(147,100,200,0.15); }
.chat-bubble {
  max-width: 80%; padding: 10px 14px; border-radius: 16px;
  font-size: 14px; line-height: 1.4; word-wrap: break-word;
  animation: fadeInUp 0.3s ease;
}
.chat-bubble.sent {
  background: linear-gradient(135deg, #f9a8d4, #c4b5fd);
  color: white; align-self: flex-end; border-bottom-right-radius: 4px;
}
.chat-bubble.received {
  background: rgba(255,255,255,0.8); color: var(--text-primary);
  align-self: flex-start; border-bottom-left-radius: 4px;
}
.chat-bubble.waiting {
  background: rgba(196,181,253,0.15); color: var(--text-primary);
  align-self: flex-start; border-bottom-left-radius: 4px;
  font-style: italic;
}
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
.post-card {
  background: rgba(255,255,255,0.7); backdrop-filter: blur(8px);
  border: 1px solid rgba(255,255,255,0.4); border-radius: 14px;
  padding: 14px; margin-bottom: 10px; animation: fadeInUp 0.3s ease;
}
.toast {
  position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
  background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
  padding: 10px 20px; border-radius: 12px; z-index: 999;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1); font-size: 14px;
  color: var(--text-primary); animation: toastIn 0.3s ease;
}
@keyframes toastIn {
  from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
  to { opacity: 1; transform: translateX(-50%) translateY(0); }
}
.sentiment-bar {
  height: 8px; border-radius: 4px; transition: width 0.5s ease;
}
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(196,181,253,0.3); border-radius: 2px; }
.profile-avatar {
  width: 40px; height: 40px; border-radius: 50%;
  background: linear-gradient(135deg, #f9a8d4, #93c5fd);
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; cursor: pointer; flex-shrink: 0;
}
.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.3);
  backdrop-filter: blur(4px); z-index: 50;
  display: flex; align-items: center; justify-content: center;
  animation: fadeIn 0.2s ease;
}
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.quiz-option {
  padding: 10px 14px; border: 2px solid rgba(196,181,253,0.3);
  border-radius: 12px; cursor: pointer; transition: all 0.2s;
  font-size: 14px;
}
.quiz-option:hover { border-color: var(--accent-pink); background: rgba(249,168,212,0.1); }
.quiz-option.selected { border-color: #ec4899; background: rgba(249,168,212,0.2); }
.expert-badge {
  background: linear-gradient(135deg, #fbbf24, #f59e0b);
  color: white; padding: 4px 10px; border-radius: 12px;
  font-size: 11px; font-weight: 600;
}
.pending-badge {
  background: linear-gradient(135deg, #a78bfa, #c4b5fd);
  color: white; padding: 4px 10px; border-radius: 12px;
  font-size: 11px; font-weight: 600;
}
.error-text {
  color: #ef4444; font-size: 12px; margin-top: 4px;
}
</style>
  <style>body { box-sizing: border-box; }</style>
 </head>
 <body class="h-full">
  <div class="app-wrapper" id="appWrapper"><!-- Clouds -->
   <svg class="cloud" style="top:5%;left:5%;width:120px" viewbox="0 0 200 100">
    <ellipse cx="70" cy="60" rx="60" ry="30" fill="#f9a8d4" opacity="0.4" /><ellipse cx="110" cy="50" rx="50" ry="35" fill="#93c5fd" opacity="0.4" /><ellipse cx="150" cy="60" rx="40" ry="25" fill="#c4b5fd" opacity="0.4" />
   </svg>
   <svg class="cloud" style="top:15%;right:10%;width:100px" viewbox="0 0 200 100">
    <ellipse cx="70" cy="60" rx="55" ry="28" fill="#93c5fd" opacity="0.4" /><ellipse cx="120" cy="50" rx="45" ry="30" fill="#f9a8d4" opacity="0.4" />
   </svg>
   <svg class="cloud" style="bottom:20%;left:15%;width:90px" viewbox="0 0 200 100">
    <ellipse cx="80" cy="55" rx="50" ry="25" fill="#c4b5fd" opacity="0.4" /><ellipse cx="130" cy="50" rx="40" ry="28" fill="#93c5fd" opacity="0.4" />
   </svg><!-- Paper Rockets -->
   <svg class="paper-rocket" style="top:10%;right:20%;width:50px" viewbox="0 0 60 60">
    <path d="M30 5 L45 50 L30 40 L15 50 Z" fill="#f9a8d4" stroke="#e879a8" stroke-width="1" /><line x1="30" y1="40" x2="30" y2="55" stroke="#93c5fd" stroke-width="1.5" /><line x1="25" y1="42" x2="20" y2="55" stroke="#c4b5fd" stroke-width="1" /><line x1="35" y1="42" x2="40" y2="55" stroke="#c4b5fd" stroke-width="1" />
   </svg>
   <svg class="paper-rocket" style="bottom:30%;right:8%;width:40px" viewbox="0 0 60 60">
    <path d="M30 5 L45 50 L30 40 L15 50 Z" fill="#93c5fd" stroke="#60a5fa" stroke-width="1" /><line x1="30" y1="40" x2="30" y2="55" stroke="#f9a8d4" stroke-width="1.5" />
   </svg><!-- ============ LOGIN PAGE ============ -->
   <div id="loginPage" class="page active" style="align-items:center;justify-content:center;padding:20px;">
    <div class="glass-card" style="width:100%;max-width:380px;padding:32px;">
     <div style="text-align:center;margin-bottom:24px;">
      <div style="font-size:40px;margin-bottom:8px;">
       üå∏
      </div>
      <h1 id="loginTitle" style="font-family:'Caveat',cursive;font-size:32px;color:var(--text-primary);margin:0;">Safe Space</h1>
      <p id="loginWelcome" style="color:var(--text-secondary);font-size:14px;margin-top:4px;">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà Safe Space</p>
     </div>
     <div style="display:flex;flex-direction:column;gap:14px;">
      <div><label for="loginUser" style="font-size:12px;color:var(--text-secondary);margin-bottom:4px;display:block;">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠ Email</label> <input id="loginUser" type="text" class="input-field" placeholder="‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠ Email">
       <div id="loginUserError" class="error-text"></div>
      </div>
      <div><label for="loginPass" style="font-size:12px;color:var(--text-secondary);margin-bottom:4px;display:block;">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label> <input id="loginPass" type="password" class="input-field" placeholder="‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
       <div id="loginPassError" class="error-text"></div>
      </div><button id="loginBtn" class="btn-gradient" style="padding:12px;font-size:16px;margin-top:4px;" onclick="doLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      <p style="text-align:center;margin:0;"><a href="#" onclick="event.preventDefault();showToast('‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÄ‡∏£‡πá‡∏ß ‡πÜ ‡∏ô‡∏µ‡πâ üìß')" style="font-size:12px;color:var(--text-secondary);text-decoration:none;">‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô?</a></p>
      <p style="text-align:center;margin:0;font-size:13px;color:var(--text-secondary);">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? <a href="#" onclick="event.preventDefault();showPage('signupPage')" style="color:#ec4899;text-decoration:none;font-weight:600;">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</a></p>
     </div>
    </div>
   </div><!-- ============ SIGNUP PAGE ============ -->
   <div id="signupPage" class="page" style="align-items:center;justify-content:center;padding:20px;">
    <div class="glass-card" style="width:100%;max-width:380px;padding:32px;">
     <div style="text-align:center;margin-bottom:24px;">
      <div style="font-size:40px;margin-bottom:8px;">
       ‚ú®
      </div>
      <h1 style="font-family:'Caveat',cursive;font-size:28px;color:var(--text-primary);margin:0;">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h1>
     </div>
     <div style="display:flex;flex-direction:column;gap:14px;">
      <div><label for="signupUser" style="font-size:12px;color:var(--text-secondary);margin-bottom:4px;display:block;">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label> <input id="signupUser" type="text" class="input-field" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ">
       <div id="signupUserError" class="error-text"></div>
      </div>
      <div><label for="signupEmail" style="font-size:12px;color:var(--text-secondary);margin-bottom:4px;display:block;">Email</label> <input id="signupEmail" type="email" class="input-field" placeholder="‡πÉ‡∏™‡πà Email ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
       <div id="signupEmailError" class="error-text"></div>
      </div>
      <div><label for="signupPass" style="font-size:12px;color:var(--text-secondary);margin-bottom:4px;display:block;">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)</label> <input id="signupPass" type="password" class="input-field" placeholder="‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
       <div id="signupPassError" class="error-text"></div>
      </div>
      <div><label for="signupPassConfirm" style="font-size:12px;color:var(--text-secondary);margin-bottom:4px;display:block;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label> <input id="signupPassConfirm" type="password" class="input-field" placeholder="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
       <div id="signupPassConfirmError" class="error-text"></div>
      </div><label style="display:flex;align-items:center;gap:8px;font-size:13px;color:var(--text-secondary);cursor:pointer;"> <input type="checkbox" id="agreeTerms" style="accent-color:#ec4899;width:16px;height:16px;"> ‡∏â‡∏±‡∏ô‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö <a href="#" onclick="event.preventDefault();showToast('‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô üìú')" style="color:#ec4899;text-decoration:none;">‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</a> </label> <button class="btn-gradient" style="padding:12px;font-size:16px;" onclick="doSignup()">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
      <p style="text-align:center;margin:0;font-size:13px;color:var(--text-secondary);">‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡πâ‡∏ß? <a href="#" onclick="event.preventDefault();showPage('loginPage')" style="color:#ec4899;text-decoration:none;font-weight:600;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a></p>
     </div>
    </div>
   </div><!-- ============ MAIN APP (after login) ============ -->
   <div id="mainApp" class="page" style="height:100%;">
    <div style="flex:1;overflow-y:auto;overflow-x:hidden;" id="mainScroll"><!-- HOME VIEW -->
     <div id="homeView" class="app-view" style="padding:16px;display:block;">
      <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
       <h2 style="font-family:'Caveat',cursive;font-size:26px;color:var(--text-primary);margin:0;">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</h2>
       <div class="profile-avatar" id="headerAvatar" onclick="showProfileModal()">
        <span id="avatarEmoji">üòä</span>
       </div>
      </header><!-- Banner -->
      <div class="banner-container" id="bannerContainer">
       <div class="banner-track" id="bannerTrack">
        <div class="banner-slide">
         ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß üíï
        </div>
        <div class="banner-slide">
         ‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏¢‡∏ù‡∏ô‡∏à‡∏∞‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏Å‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î üåà
        </div>
        <div class="banner-slide">
         ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ï‡∏±‡∏ß‡∏î‡∏µ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ üå∏
        </div>
        <div class="banner-slide">
         ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏¥‡∏î ‚≠ê
        </div>
        <div class="banner-slide">
         ‡πÉ‡∏à‡πÄ‡∏¢‡πá‡∏ô‡πÜ ‡∏ó‡∏µ‡∏•‡∏∞‡∏ß‡∏±‡∏ô ü¶ã
        </div>
       </div>
      </div><!-- Features -->
      <div style="margin-top:20px;display:flex;flex-direction:column;gap:14px;">
       <div class="feature-card" onclick="openChatAI()">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px;">
         <div style="width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,#f9a8d4,#c4b5fd);display:flex;align-items:center;justify-content:center;font-size:22px;">
          ü§ñ
         </div>
         <div>
          <h3 style="margin:0;font-size:16px;color:var(--text-primary);font-weight:700;">‡πÅ‡∏ä‡∏ó‡∏Å‡∏±‡∏ö AI</h3>
          <p style="margin:0;font-size:12px;color:var(--text-secondary);">‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤ AI ‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤</p>
         </div>
        </div><button class="btn-gradient" style="width:100%;padding:10px;font-size:14px;" onclick="event.stopPropagation();openChatAI()">‡πÅ‡∏ä‡∏ó‡πÄ‡∏•‡∏¢</button>
       </div>
       <div class="feature-card" onclick="openExpertChat()">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px;">
         <div style="width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,#93c5fd,#f9a8d4);display:flex;align-items:center;justify-content:center;font-size:22px;">
          üë©‚Äç‚öïÔ∏è
         </div>
         <div>
          <h3 style="margin:0;font-size:16px;color:var(--text-primary);font-weight:700;">‡πÅ‡∏ä‡∏ó‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç</h3>
          <p style="margin:0;font-size:12px;color:var(--text-secondary);">‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏à‡∏£‡∏¥‡∏á‡∏Ñ‡∏ô‡∏ô‡∏∂‡∏á</p>
         </div>
        </div><button class="btn-gradient" style="width:100%;padding:10px;font-size:14px;" onclick="event.stopPropagation();openExpertChat()">‡πÅ‡∏ä‡∏ó‡πÄ‡∏•‡∏¢</button>
       </div>
       <div class="feature-card" onclick="openCommunity()">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px;">
         <div style="width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,#c4b5fd,#93c5fd);display:flex;align-items:center;justify-content:center;font-size:22px;">
          üë•
         </div>
         <div>
          <h3 style="margin:0;font-size:16px;color:var(--text-primary);font-weight:700;">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ä‡∏∏‡∏°‡∏ä‡∏ô</h3>
          <p style="margin:0;font-size:12px;color:var(--text-secondary);">‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏ä‡∏ó ‡πÅ‡∏ö‡πà‡∏á‡∏õ‡∏±‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå</p>
         </div>
        </div><button class="btn-gradient" style="width:100%;padding:10px;font-size:14px;" onclick="event.stopPropagation();openCommunity()">‡πÅ‡∏ä‡∏ó‡πÄ‡∏•‡∏¢</button>
       </div>
      </div>
      <div style="height:20px;"></div>
     </div><!-- CHAT AI VIEW -->
     <div id="chatAIView" class="app-view" style="display:none;height:100%;flex-direction:column;">
      <header style="display:flex;align-items:center;gap:12px;padding:16px;background:rgba(255,255,255,0.6);backdrop-filter:blur(10px);"><button onclick="goHome()" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--text-primary);">‚Üê</button>
       <div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#f9a8d4,#c4b5fd);display:flex;align-items:center;justify-content:center;font-size:18px;">
        ü§ñ
       </div>
       <div>
        <h3 style="margin:0;font-size:16px;color:var(--text-primary);">‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤ AI</h3>
        <p style="margin:0;font-size:11px;color:var(--text-secondary);">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏°‡∏≠</p>
       </div>
      </header>
      <div id="aiChatMessages" style="flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:10px;">
       <div class="chat-bubble received">
        ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞ üå∏ ‡∏â‡∏±‡∏ô‡∏Ñ‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤ AI ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á‡∏Ñ‡∏∞
       </div>
      </div>
      <div style="padding:12px;display:flex;gap:8px;background:rgba(255,255,255,0.6);backdrop-filter:blur(10px);"><label for="aiChatInput" class="sr-only" style="position:absolute;width:1px;height:1px;overflow:hidden;">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</label> <input id="aiChatInput" type="text" class="input-field" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì..." style="flex:1;" onkeydown="if(event.key==='Enter'){event.preventDefault();sendAIChat();}"> <button onclick="sendAIChat()" class="btn-gradient" style="padding:10px 16px;font-size:14px;">‡∏™‡πà‡∏á</button>
      </div>
     </div><!-- EXPERT CHAT VIEW -->
     <div id="expertChatView" class="app-view" style="display:none;height:100%;flex-direction:column;">
      <header style="display:flex;align-items:center;gap:12px;padding:16px;background:rgba(255,255,255,0.6);backdrop-filter:blur(10px);"><button onclick="goHome()" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--text-primary);">‚Üê</button>
       <div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#93c5fd,#f9a8d4);display:flex;align-items:center;justify-content:center;font-size:18px;">
        üë©‚Äç‚öïÔ∏è
       </div>
       <div>
        <h3 style="margin:0;font-size:16px;color:var(--text-primary);">‡πÅ‡∏ä‡∏ó‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç</h3>
        <p style="margin:0;font-size:11px;color:var(--text-secondary);">‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ô‡∏à‡∏£‡∏¥‡∏á</p>
       </div>
      </header>
      <div id="expertChatMessages" style="flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:10px;">
       <div class="chat-bubble received">
        ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞ üíô ‡∏â‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏à‡∏¥‡∏ï ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ñ‡∏∏‡∏ì
       </div>
      </div>
      <div style="padding:12px;display:flex;gap:8px;background:rgba(255,255,255,0.6);backdrop-filter:blur(10px);"><label for="expertChatInput" class="sr-only" style="position:absolute;width:1px;height:1px;overflow:hidden;">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</label> <input id="expertChatInput" type="text" class="input-field" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì..." style="flex:1;" onkeydown="if(event.key==='Enter'){event.preventDefault();sendExpertChat();}"> <button onclick="sendExpertChat()" class="btn-gradient" style="padding:10px 16px;font-size:14px;">‡∏™‡πà‡∏á</button>
      </div>
     </div><!-- COMMUNITY VIEW -->
     <div id="communityView" class="app-view" style="display:none;padding:16px;">
      <header style="display:flex;align-items:center;gap:12px;margin-bottom:16px;"><button onclick="goHome()" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--text-primary);">‚Üê</button>
       <h2 style="font-family:'Caveat',cursive;font-size:24px;color:var(--text-primary);margin:0;">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ä‡∏∏‡∏°‡∏ä‡∏ô</h2>
      </header>
      <div id="communityRooms" style="display:flex;flex-direction:column;gap:10px;"></div>
      <div style="margin-top:16px;"><label for="newRoomName" style="font-size:12px;color:var(--text-secondary);margin-bottom:4px;display:block;">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</label>
       <div style="display:flex;gap:8px;"><input id="newRoomName" type="text" class="input-field" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á..." style="flex:1;"> <button onclick="createRoom()" class="btn-gradient" style="padding:10px 16px;font-size:14px;">‡∏™‡∏£‡πâ‡∏≤‡∏á</button>
       </div>
      </div>
     </div><!-- COMMUNITY CHAT VIEW -->
     <div id="communityChatView" class="app-view" style="display:none;height:100%;flex-direction:column;">
      <header style="display:flex;align-items:center;gap:12px;padding:16px;background:rgba(255,255,255,0.6);backdrop-filter:blur(10px);"><button onclick="openCommunity()" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--text-primary);">‚Üê</button>
       <div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#c4b5fd,#93c5fd);display:flex;align-items:center;justify-content:center;font-size:18px;">
        üë•
       </div>
       <div>
        <h3 id="commRoomTitle" style="margin:0;font-size:16px;color:var(--text-primary);">‡∏´‡πâ‡∏≠‡∏á</h3>
       </div>
      </header>
      <div id="commChatMessages" style="flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:10px;"></div>
      <div style="padding:12px;display:flex;gap:8px;background:rgba(255,255,255,0.6);backdrop-filter:blur(10px);"><label for="commChatInput" class="sr-only" style="position:absolute;width:1px;height:1px;overflow:hidden;">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</label> <input id="commChatInput" type="text" class="input-field" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì..." style="flex:1;" onkeydown="if(event.key==='Enter'){event.preventDefault();sendCommChat();}"> <button onclick="sendCommChat()" class="btn-gradient" style="padding:10px 16px;font-size:14px;">‡∏™‡πà‡∏á</button>
      </div>
     </div><!-- COZY SPACE VIEW (Posts/Feed) -->
     <div id="cozyView" class="app-view" style="display:none;padding:16px;">
      <header style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
       <h2 style="font-family:'Caveat',cursive;font-size:24px;color:var(--text-primary);margin:0;">ü§ç ‡∏°‡∏∏‡∏°‡∏™‡∏ö‡∏≤‡∏¢‡πÉ‡∏à</h2>
      </header>
      <div style="margin-bottom:14px;"><label for="postInput" style="font-size:12px;color:var(--text-secondary);margin-bottom:4px;display:block;">‡πÅ‡∏ä‡∏£‡πå‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÉ‡∏à</label> <textarea id="postInput" class="input-field" rows="3" placeholder="‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏¥‡∏î‡∏≠‡∏∞‡πÑ‡∏£‡∏≠‡∏¢‡∏π‡πà üí≠" style="resize:none;font-family:'Quicksand','Noto Sans Thai',sans-serif;"></textarea> <button onclick="createPost()" class="btn-gradient" style="width:100%;padding:10px;font-size:14px;margin-top:8px;">‡πÇ‡∏û‡∏™‡∏ï‡πå ‚ú®</button>
      </div>
      <div id="postsFeed" style="display:flex;flex-direction:column;gap:10px;"></div>
     </div><!-- NOTIFICATIONS VIEW -->
     <div id="notiView" class="app-view" style="display:none;padding:16px;">
      <header style="margin-bottom:16px;">
       <h2 style="font-family:'Caveat',cursive;font-size:24px;color:var(--text-primary);margin:0;">üîî ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h2>
      </header>
      <div id="notificationsList" style="display:flex;flex-direction:column;gap:8px;">
       <p style="text-align:center;color:var(--text-secondary);font-size:14px;padding:40px 0;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô üåô</p>
      </div>
     </div><!-- MESSAGES VIEW -->
     <div id="messagesView" class="app-view" style="display:none;padding:16px;">
      <header style="margin-bottom:16px;">
       <h2 style="font-family:'Caveat',cursive;font-size:24px;color:var(--text-primary);margin:0;">üí¨ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</h2>
      </header>
      <div id="messagesList" style="display:flex;flex-direction:column;gap:10px;"></div>
     </div><!-- PROFILE / SETTINGS VIEW -->
     <div id="profileView" class="app-view" style="display:none;padding:16px;">
      <header style="margin-bottom:16px;">
       <h2 style="font-family:'Caveat',cursive;font-size:24px;color:var(--text-primary);margin:0;">üë§ ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h2>
      </header>
      <div class="glass-card" style="padding:20px;margin-bottom:16px;text-align:center;">
       <div style="width:70px;height:70px;border-radius:50%;background:linear-gradient(135deg,#f9a8d4,#93c5fd);display:flex;align-items:center;justify-content:center;font-size:32px;margin:0 auto 12px;" id="profileBigAvatar">
        üòä
       </div>
       <h3 id="profileDisplayName" style="margin:0;color:var(--text-primary);font-size:18px;">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h3>
       <p id="profileDisplayEmail" style="margin:4px 0 0;color:var(--text-secondary);font-size:13px;">user@email.com</p>
      </div><!-- Sentiment Analysis -->
      <div class="feature-card" style="margin-bottom:14px;cursor:default;">
       <h3 style="margin:0 0 12px;font-size:16px;color:var(--text-primary);font-weight:700;">üìä ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå</h3>
       <div id="sentimentChart" style="margin-bottom:12px;">
        <div style="display:flex;flex-direction:column;gap:8px;" id="sentimentBars">
         <p style="text-align:center;color:var(--text-secondary);font-size:13px;">‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå!</p>
        </div>
       </div><button onclick="startQuiz()" class="btn-gradient" style="width:100%;padding:10px;font-size:14px;">‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö üß†</button>
      </div><!-- Expert Registration -->
      <div class="feature-card" style="margin-bottom:14px;">
       <h3 style="margin:0 0 8px;font-size:16px;color:var(--text-primary);font-weight:700;">üíº ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç</h3>
       <p style="margin:0 0 12px;font-size:13px;color:var(--text-secondary);">‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÑ‡∏î‡πâ</p>
       <div id="expertStatus" style="display:flex;gap:8px;"></div>
      </div><!-- Logout Button -->
      <div style="margin-bottom:14px;"><button onclick="doLogout()" style="width:100%;padding:12px;border:2px solid rgba(249,168,212,0.4);border-radius:14px;background:transparent;color:var(--text-primary);font-family:'Quicksand','Noto Sans Thai',sans-serif;font-size:14px;font-weight:600;cursor:pointer;">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>
     </div><!-- QUIZ VIEW -->
     <div id="quizView" class="app-view" style="display:none;padding:16px;">
      <header style="display:flex;align-items:center;gap:12px;margin-bottom:16px;"><button onclick="showAppView('profileView');switchNav('navProfile')" style="background:none;border:none;font-size:20px;cursor:pointer;color:var(--text-primary);">‚Üê</button>
       <h2 style="font-family:'Caveat',cursive;font-size:24px;color:var(--text-primary);margin:0;">‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏à‡∏¥‡∏ï üß†</h2>
      </header>
      <div id="quizContent"></div>
     </div>
    </div><!-- BOTTOM NAV -->
    <nav class="bottom-nav" id="bottomNav" aria-label="‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å">
     <div class="nav-item active" id="navCozy" onclick="switchNav('navCozy');showAppView('cozyView')">
      <svg viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
       <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" />
      </svg><span>‡∏™‡∏ö‡∏≤‡∏¢‡πÉ‡∏à</span>
     </div>
     <div class="nav-item" id="navNoti" onclick="switchNav('navNoti');showAppView('notiView')">
      <svg viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
       <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" /><path d="M13.73 21a2 2 0 0 1-3.46 0" />
      </svg><span>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</span>
     </div>
     <div class="nav-item" id="navHome" onclick="switchNav('navHome');showAppView('homeView')">
      <svg viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
       <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" /><polyline points="9 22 9 12 15 12 15 22" />
      </svg><span>‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</span>
     </div>
     <div class="nav-item" id="navMsg" onclick="switchNav('navMsg');showAppView('messagesView')">
      <svg viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
       <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
      </svg><span>‡πÅ‡∏ä‡∏ó</span>
     </div>
     <div class="nav-item" id="navProfile" onclick="switchNav('navProfile');showAppView('profileView')">
      <svg viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
       <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" />
      </svg><span>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</span>
     </div>
    </nav>
   </div><!-- Profile Modal -->
   <div id="profileModal" style="display:none;"></div><!-- Toast -->
   <div id="toastContainer"></div>
  </div>
  <script>
// ==================== STATE ====================
let currentUser = { username: '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', email: 'user@email.com', emoji: 'üòä', isExpert: false };
let allData = [];
let registeredUsers = [];
let currentCommunityRoom = null;
let bannerIndex = 0;
let bannerInterval = null;

const defaultConfig = {
  app_title: 'Safe Space',
  welcome_text: '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà Safe Space',
  banner_text_1: '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß üíï',
  banner_text_2: '‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏¢‡∏ù‡∏ô‡∏à‡∏∞‡∏´‡∏¢‡∏∏‡∏î‡∏ï‡∏Å‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î üåà',
  background_color: '#fce4f2',
  surface_color: '#ffffff',
  text_color: '#4a3560',
  accent_color: '#f9a8d4',
  secondary_color: '#93c5fd',
  font_family: 'Quicksand',
  font_size: 16
};

// ==================== ELEMENT SDK ====================
if (window.elementSdk) {
  window.elementSdk.init({
    defaultConfig,
    onConfigChange: async (config) => {
      const bg = config.background_color || defaultConfig.background_color;
      const surface = config.surface_color || defaultConfig.surface_color;
      const text = config.text_color || defaultConfig.text_color;
      const accent = config.accent_color || defaultConfig.accent_color;
      const secondary = config.secondary_color || defaultConfig.secondary_color;
      const font = config.font_family || defaultConfig.font_family;
      const fontSize = config.font_size || defaultConfig.font_size;

      document.documentElement.style.setProperty('--bg-gradient-1', bg);
      document.documentElement.style.setProperty('--text-primary', text);
      document.documentElement.style.setProperty('--accent-pink', accent);
      document.documentElement.style.setProperty('--accent-blue', secondary);
      document.documentElement.style.setProperty('--card-bg', surface);

      document.body.style.fontFamily = `${font}, Quicksand, 'Noto Sans Thai', sans-serif`;
      document.body.style.fontSize = `${fontSize}px`;

      const title = document.getElementById('loginTitle');
      if (title) title.textContent = config.app_title || defaultConfig.app_title;
      const welcome = document.getElementById('loginWelcome');
      if (welcome) welcome.textContent = config.welcome_text || defaultConfig.welcome_text;

      const slides = document.querySelectorAll('.banner-slide');
      if (slides[0]) slides[0].textContent = config.banner_text_1 || defaultConfig.banner_text_1;
      if (slides[1]) slides[1].textContent = config.banner_text_2 || defaultConfig.banner_text_2;
    },
    mapToCapabilities: (config) => ({
      recolorables: [
        { get: () => config.background_color || defaultConfig.background_color, set: (v) => { config.background_color = v; window.elementSdk.setConfig({ background_color: v }); } },
        { get: () => config.surface_color || defaultConfig.surface_color, set: (v) => { config.surface_color = v; window.elementSdk.setConfig({ surface_color: v }); } },
        { get: () => config.text_color || defaultConfig.text_color, set: (v) => { config.text_color = v; window.elementSdk.setConfig({ text_color: v }); } },
        { get: () => config.accent_color || defaultConfig.accent_color, set: (v) => { config.accent_color = v; window.elementSdk.setConfig({ accent_color: v }); } },
        { get: () => config.secondary_color || defaultConfig.secondary_color, set: (v) => { config.secondary_color = v; window.elementSdk.setConfig({ secondary_color: v }); } }
      ],
      borderables: [],
      fontEditable: {
        get: () => config.font_family || defaultConfig.font_family,
        set: (v) => { config.font_family = v; window.elementSdk.setConfig({ font_family: v }); }
      },
      fontSizeable: {
        get: () => config.font_size || defaultConfig.font_size,
        set: (v) => { config.font_size = v; window.elementSdk.setConfig({ font_size: v }); }
      }
    }),
    mapToEditPanelValues: (config) => new Map([
      ['app_title', config.app_title || defaultConfig.app_title],
      ['welcome_text', config.welcome_text || defaultConfig.welcome_text],
      ['banner_text_1', config.banner_text_1 || defaultConfig.banner_text_1],
      ['banner_text_2', config.banner_text_2 || defaultConfig.banner_text_2]
    ])
  });
}

// ==================== DATA SDK ====================
const dataHandler = {
  onDataChanged(data) {
    allData = data;
    registeredUsers = data.filter(d => d.type === 'user_account');
    renderPosts();
    renderCommunityRooms();
    renderMessages();
    renderNotifications();
    if (currentCommunityRoom) renderCommChat();
    renderSentiment();
    renderExpertStatus();
  }
};

(async () => {
  if (window.dataSdk) {
    const r = await window.dataSdk.init(dataHandler);
    if (!r.isOk) console.error('Data SDK init failed');
  }
})();

// ==================== NAVIGATION ====================
function showPage(pageId) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(pageId).classList.add('active');
  clearErrors();
}

function showAppView(viewId) {
  document.querySelectorAll('.app-view').forEach(v => v.style.display = 'none');
  const view = document.getElementById(viewId);
  if (view) {
    const isChatView = ['chatAIView','expertChatView','communityChatView'].includes(viewId);
    view.style.display = isChatView ? 'flex' : 'block';
  }
  document.getElementById('mainScroll').scrollTop = 0;
}

function switchNav(navId) {
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById(navId).classList.add('active');
}

function goHome() {
  showAppView('homeView');
  switchNav('navHome');
}

// ==================== ERROR HANDLING ====================
function clearErrors() {
  document.querySelectorAll('.error-text').forEach(e => e.textContent = '');
}

function showError(elementId, message) {
  const el = document.getElementById(elementId);
  if (el) el.textContent = message;
}

// ==================== HASH PASSWORD SIMULATION ====================
function simpleHash(str) {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    const char = str.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash;
  }
  return Math.abs(hash).toString(16);
}

// ==================== AUTH ====================
function validateEmail(email) {
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

function validatePassword(pass) {
  return pass.length >= 6;
}

async function doLogin() {
  clearErrors();
  const userInput = document.getElementById('loginUser').value.trim();
  const password = document.getElementById('loginPass').value.trim();

  if (!userInput) { showError('loginUserError', '‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠ Email'); return; }
  if (!password) { showError('loginPassError', '‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô'); return; }

  const user = registeredUsers.find(u => u.username === userInput || u.email === userInput);
  if (!user) { showError('loginUserError', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ'); return; }

  const passwordHash = simpleHash(password);
  if (user.password_hash !== passwordHash) {
    showError('loginPassError', '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
    if (window.dataSdk) {
      const loginAttempts = (user.login_attempts || 0) + 1;
      await window.dataSdk.update({ ...user, login_attempts: loginAttempts });
    }
    return;
  }

  currentUser.username = user.username;
  currentUser.email = user.email;
  currentUser.emoji = user.profile_emoji || 'üòä';
  currentUser.isExpert = user.expert_status === 'approved';
  updateProfileDisplay();

  if (window.dataSdk) {
    await window.dataSdk.update({ ...user, last_login: new Date().toISOString(), login_attempts: 0 });
  }

  showPage('mainApp');
  showAppView('homeView');
  switchNav('navHome');
  startBanner();
  showToast('‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤! üå∏');
}

async function doSignup() {
  clearErrors();
  const username = document.getElementById('signupUser').value.trim();
  const email = document.getElementById('signupEmail').value.trim();
  const password = document.getElementById('signupPass').value.trim();
  const passConfirm = document.getElementById('signupPassConfirm').value.trim();
  const agree = document.getElementById('agreeTerms').checked;

  if (!username) { showError('signupUserError', '‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ'); return; }
  if (username.length < 3) { showError('signupUserError', '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£'); return; }
  if (registeredUsers.some(u => u.username === username)) { showError('signupUserError', '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß'); return; }

  if (!email) { showError('signupEmailError', '‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏™‡πà Email'); return; }
  if (!validateEmail(email)) { showError('signupEmailError', 'Email ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return; }
  if (registeredUsers.some(u => u.email === email)) { showError('signupEmailError', 'Email ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß'); return; }

  if (!password) { showError('signupPassError', '‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô'); return; }
  if (!validatePassword(password)) { showError('signupPassError', '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£'); return; }

  if (password !== passConfirm) { showError('signupPassConfirmError', '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô'); return; }
  if (!agree) { showError('signupUserError', '‡πÇ‡∏õ‡∏£‡∏î‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç'); return; }

  if (window.dataSdk) {
    const passwordHash = simpleHash(password);
    const result = await window.dataSdk.create({
      type: 'user_account',
      username, email, password_hash: passwordHash,
      profile_emoji: 'üòä',
      expert_status: 'none',
      login_attempts: 0,
      timestamp: new Date().toISOString()
    });

    if (result.isOk) {
      currentUser.username = username;
      currentUser.email = email;
      currentUser.emoji = 'üòä';
      currentUser.isExpert = false;
      updateProfileDisplay();
      showPage('mainApp');
      showAppView('homeView');
      switchNav('navHome');
      startBanner();
      showToast('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! ‚ú®');
    } else {
      showError('signupUserError', '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
    }
  }
}

function doLogout() {
  currentUser.isExpert = false;
  showPage('loginPage');
  document.getElementById('loginUser').value = '';
  document.getElementById('loginPass').value = '';
  clearErrors();
  if (bannerInterval) clearInterval(bannerInterval);
}

function updateProfileDisplay() {
  document.getElementById('avatarEmoji').textContent = currentUser.emoji;
  document.getElementById('profileBigAvatar').textContent = currentUser.emoji;
  document.getElementById('profileDisplayName').textContent = currentUser.username;
  document.getElementById('profileDisplayEmail').textContent = currentUser.email;
}

// ==================== PROFILE MODAL ====================
function showProfileModal() {
  const modal = document.getElementById('profileModal');
  const emojis = ['üòä','üòé','ü•∞','ü§ó','ü¶Ñ','üå∏','üåà','‚≠ê','üíô','üê±','üêª','üå∫'];
  modal.innerHTML = `
    <div class="modal-overlay" onclick="if(event.target===this)closeProfileModal()">
      <div class="glass-card" style="width:90%;max-width:340px;padding:24px;">
        <h3 style="margin:0 0 16px;text-align:center;font-family:'Caveat',cursive;font-size:22px;color:var(--text-primary);">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</h3>
        <div style="margin-bottom:14px;">
          <label for="editName" style="font-size:12px;color:var(--text-secondary);display:block;margin-bottom:4px;">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
          <input id="editName" type="text" class="input-field" value="${currentUser.username}" disabled style="opacity:0.6;cursor:not-allowed;">
          <p style="font-size:11px;color:var(--text-secondary);margin:4px 0 0;">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</p>
        </div>
        <div style="margin-bottom:14px;">
          <label style="font-size:12px;color:var(--text-secondary);display:block;margin-bottom:8px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå</label>
          <div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;">
            ${emojis.map(e => `<div onclick="selectEmoji('${e}')" style="width:40px;height:40px;border-radius:50%;background:${e===currentUser.emoji?'linear-gradient(135deg,#f9a8d4,#93c5fd)':'rgba(196,181,253,0.2)'};display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;transition:all 0.2s;" class="emoji-pick">${e}</div>`).join('')}
          </div>
        </div>
        <div style="display:flex;gap:8px;">
          <button onclick="closeProfileModal()" style="flex:1;padding:10px;border:2px solid rgba(196,181,253,0.3);border-radius:12px;background:transparent;font-family:'Quicksand','Noto Sans Thai',sans-serif;cursor:pointer;color:var(--text-primary);">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button onclick="saveProfile()" class="btn-gradient" style="flex:1;padding:10px;font-size:14px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      </div>
    </div>`;
  modal.style.display = 'block';
}

function selectEmoji(e) {
  currentUser.emoji = e;
  document.querySelectorAll('.emoji-pick').forEach(el => {
    el.style.background = el.textContent === e ? 'linear-gradient(135deg,#f9a8d4,#93c5fd)' : 'rgba(196,181,253,0.2)';
  });
}

function closeProfileModal() { document.getElementById('profileModal').style.display = 'none'; }

async function saveProfile() {
  const user = registeredUsers.find(u => u.username === currentUser.username);
  if (user && window.dataSdk) {
    await window.dataSdk.update({ ...user, profile_emoji: currentUser.emoji });
  }
  updateProfileDisplay();
  closeProfileModal();
  showToast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! üåü');
}

// ==================== BANNER ====================
function startBanner() {
  const slides = document.querySelectorAll('.banner-slide');
  if (slides.length === 0) return;
  bannerIndex = 0;
  if (bannerInterval) clearInterval(bannerInterval);
  bannerInterval = setInterval(() => {
    bannerIndex = (bannerIndex + 1) % slides.length;
    document.getElementById('bannerTrack').style.transform = `translateX(-${bannerIndex * 100}%)`;
  }, 3500);
}

// ==================== TOAST ====================
function showToast(msg) {
  const c = document.getElementById('toastContainer');
  const t = document.createElement('div');
  t.className = 'toast';
  t.textContent = msg;
  c.appendChild(t);
  setTimeout(() => { t.style.opacity = '0'; t.style.transition = 'opacity 0.3s'; setTimeout(() => t.remove(), 300); }, 2500);
}

// ==================== AI RESPONSES (More Natural & Varied) ====================
const aiResponses = [
  "‡∏â‡∏±‡∏ô‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏™‡∏∂‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ô‡∏±‡πâ‡∏ô‡∏™‡∏°‡∏Ñ‡∏ß‡∏£‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏≠‡∏Å‡∏â‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°‡∏Ñ‡∏∞",
  "‡∏ü‡∏±‡∏á‡∏î‡∏π‡∏¢‡∏≤‡∏Å‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏ß‡πà‡∏≤‡∏°‡∏±‡∏ô‡πÇ‡∏≠‡πÄ‡∏Ñ‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÇ‡∏≠‡πÄ‡∏Ñ ‡∏ö‡∏≤‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏ô‡∏±‡∏Å‡πÉ‡∏à‡∏Å‡∏ß‡πà‡∏≤ ‡∏ö‡∏≤‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏£‡∏≤‡πÅ‡∏Ñ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà",
  "‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÑ‡∏ß‡πâ‡∏ß‡∏≤‡∏á‡πÉ‡∏à‡∏ö‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏â‡∏±‡∏ô‡∏ü‡∏±‡∏á ‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡πâ‡∏≤‡∏´‡∏≤‡∏ç ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏•‡∏∂‡∏Å‡πÜ‡∏î‡∏π‡∏ö‡πâ‡∏≤‡∏á‡πÑ‡∏´‡∏°‡∏Ñ‡∏∞ ‡∏ô‡∏±‡πà‡∏á‡∏™‡∏ö‡∏≤‡∏¢ ‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏¥‡∏î‡∏ñ‡∏∂‡∏á‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢",
  "‡∏â‡∏±‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡πà‡∏∞ ‡∏ö‡∏≤‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏à‡∏¥‡∏ï‡πÉ‡∏à‡πÄ‡∏£‡∏≤‡∏à‡∏∂‡∏á‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏ó‡πà‡∏ß‡∏°‡∏ó‡πâ‡∏ô ‡∏•‡∏≠‡∏á‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢‡πÄ‡∏ö‡∏≤‡πÜ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÅ‡∏ï‡∏∞‡∏ú‡∏¥‡∏ß‡∏™‡∏¥‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏£‡∏≠‡∏ö‡∏ï‡∏±‡∏ß ‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏•‡πà‡∏ô ‡∏ü‡∏±‡∏á‡πÄ‡∏û‡∏•‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà‡∏ô‡∏±‡πà‡∏á‡πÄ‡∏á‡∏µ‡∏¢‡∏ö ‡πÜ",
  "‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Ñ‡πà‡∏∞ ‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏•‡πá‡∏Å‡πÜ‡∏≠‡∏∞‡πÑ‡∏£‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏¥‡πâ‡∏°‡πÑ‡∏î‡πâ‡∏ö‡πâ‡∏≤‡∏á? ‡πÄ‡∏£‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏∏‡∏Ç ‡πÜ ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞",
  "‡∏â‡∏±‡∏ô‡∏ä‡∏∑‡πà‡∏ô‡∏ä‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏ß‡πâ‡∏ß‡∏≤‡∏á‡πÉ‡∏à‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏à ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏°‡∏ï‡∏ï‡∏≤‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏ô‡∏±‡πâ‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡∏Ñ‡πà‡∏∞ ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏û‡∏π‡∏î‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏ö‡πâ‡∏≤‡∏á?",
  "‡∏°‡∏±‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î‡∏ô‡∏±‡πâ‡∏ô‡∏Ñ‡πà‡∏∞ ‡∏â‡∏±‡∏ô‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡πÉ‡∏à ‡∏°‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏°‡∏≤‡∏ò‡∏¥‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÑ‡∏î‡πâ‡∏Å‡∏±‡∏ô ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ? ‡∏°‡∏µ‡πÅ‡∏ú‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ô‡∏≤‡∏ó‡∏µ‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ö‡πâ‡∏≤‡∏á‡∏Ñ‡∏∞",
  "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ô‡∏±‡πâ‡∏ô‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ñ‡πà‡∏∞ ‡∏Ñ‡∏∏‡∏ì‡∏ô‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏ö‡∏û‡∏≠‡πÑ‡∏´‡∏° ‡∏ö‡πà‡∏≠‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡πÄ‡∏•‡∏¢‡∏ô‡∏∞ ‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥ ‡∏ô‡∏≠‡∏ô‡∏û‡∏≠ ‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß‡∏õ‡∏Å‡∏ï‡∏¥",
  "‡∏â‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏™‡∏°‡∏≠‡∏Ñ‡πà‡∏∞ ‡∏à‡∏≥‡πÑ‡∏ß‡πâ‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏£‡∏á ‡∏ö‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏à‡∏∞‡∏´‡∏ô‡∏±‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏ö‡πâ‡∏≤‡∏á ‡πÅ‡∏ï‡πà‡∏°‡∏±‡∏ô‡∏Å‡πá‡πÇ‡∏≠‡πÄ‡∏Ñ‡∏Ñ‡πà‡∏∞ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏≠‡∏¢‡∏π‡πà",
  "‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏à‡∏Å‡∏•‡πâ‡∏≤‡∏ô‡∏±‡∏Å‡πÄ‡∏•‡∏¢‡∏ó‡∏µ‡πà‡∏û‡∏π‡∏î‡∏ñ‡∏∂‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏Ñ‡πà‡∏∞ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÉ‡∏ô‡πÉ‡∏à‡∏Ñ‡∏∏‡∏ì‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏á? ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏ß‡πâ‡∏ß‡∏≤‡∏á‡πÉ‡∏à? ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏á‡∏µ‡∏¢‡∏ö ‡πÜ? ‡∏ö‡∏≤‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏£‡∏≤‡πÅ‡∏Ñ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏á‡∏ö",
  "‡∏î‡∏π‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡πà‡∏≤‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏¢‡∏≤‡∏Å ‡πÜ ‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡πÅ‡∏ï‡πà‡∏â‡∏±‡∏ô‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏≤‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡∏ô‡∏±‡πà‡∏ô‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡∏ó‡∏µ‡πà‡∏â‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°‡∏Ñ‡∏∞",
  "‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏Å‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡πÅ‡∏ï‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ñ‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏°‡∏±‡∏ô‡∏Å‡∏•‡∏ö‡∏ô‡∏¥‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏≥‡∏ô‡∏∂‡∏Å ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏¢‡∏≤‡∏Å‡πÜ ‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô‡∏£‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏™‡∏°‡∏≠ üåà",
  "‡∏ö‡∏≤‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏™‡∏¥‡πà‡∏á‡πÄ‡∏•‡πá‡∏Å‡πÜ‡∏ô‡πâ‡∏≠‡∏¢‡πÜ‡∏Å‡πá‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏î‡πâ‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏à‡∏ô‡∏µ‡πà‡πÅ‡∏´‡∏•‡∏∞ ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏ì‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏ó‡πà‡∏ß‡∏°‡∏ó‡πâ‡∏≠ ‡∏•‡∏≠‡∏á‡∏ó‡∏≥‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏î‡∏µ ‡∏ñ‡∏∂‡∏á‡πÅ‡∏°‡πâ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏Ñ‡πà‡∏™‡∏¥‡πà‡∏á‡πÄ‡∏•‡πá‡∏Å‡πÜ"
];

// ==================== CHAT AI ====================
function openChatAI() {
  showAppView('chatAIView');
  switchNav('navHome');
}

async function sendAIChat() {
  const input = document.getElementById('aiChatInput');
  const msg = input.value.trim();
  if (!msg) return;
  input.value = '';
  const container = document.getElementById('aiChatMessages');
  const sentBubble = document.createElement('div');
  sentBubble.className = 'chat-bubble sent';
  sentBubble.textContent = msg;
  container.appendChild(sentBubble);
  container.scrollTop = container.scrollHeight;

  if (window.dataSdk) {
    await window.dataSdk.create({
      type: 'chat_ai',
      content: msg,
      sender: currentUser.username,
      timestamp: new Date().toISOString()
    });
  }

  setTimeout(() => {
    const response = aiResponses[Math.floor(Math.random() * aiResponses.length)];
    const recBubble = document.createElement('div');
    recBubble.className = 'chat-bubble received';
    recBubble.textContent = response;
    container.appendChild(recBubble);
    container.scrollTop = container.scrollHeight;
  }, 800 + Math.random() * 1200);
}

// ==================== EXPERT CHAT ==================== 
function openExpertChat() {
  showAppView('expertChatView');
  switchNav('navHome');
}

async function sendExpertChat() {
  const input = document.getElementById('expertChatInput');
  const msg = input.value.trim();
  if (!msg) return;
  input.value = '';
  const container = document.getElementById('expertChatMessages');
  const sentBubble = document.createElement('div');
  sentBubble.className = 'chat-bubble sent';
  sentBubble.textContent = msg;
  container.appendChild(sentBubble);
  container.scrollTop = container.scrollHeight;

  if (window.dataSdk) {
    await window.dataSdk.create({
      type: 'chat_expert',
      content: msg,
      sender: currentUser.username,
      timestamp: new Date().toISOString(),
      expert_responding: false
    });
  }

  const waitingBubble = document.createElement('div');
  waitingBubble.className = 'chat-bubble waiting';
  waitingBubble.textContent = '‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç...';
  waitingBubble.id = 'waiting-' + Date.now();
  container.appendChild(waitingBubble);
  container.scrollTop = container.scrollHeight;
}

// ==================== EXPERT REQUEST SYSTEM ====================
async function toggleExpertStatus() {
  if (currentUser.isExpert) {
    currentUser.isExpert = false;
    const user = registeredUsers.find(u => u.username === currentUser.username);
    if (user && window.dataSdk) {
      await window.dataSdk.update({ ...user, expert_status: 'none' });
    }
    showToast('‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡πÅ‡∏•‡πâ‡∏ß');
  } else {
    if (window.dataSdk) {
      const result = await window.dataSdk.create({
        type: 'expert_request',
        username: currentUser.username,
        email: currentUser.email,
        expert_request_status: 'pending',
        timestamp: new Date().toISOString()
      });
      if (result.isOk) {
        showToast('‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡πÅ‡∏•‡πâ‡∏ß! ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏ß‡πá‡∏ö üìã');
      }
    }
  }
  renderExpertStatus();
}

function renderExpertStatus() {
  const container = document.getElementById('expertStatus');
  if (!container) return;

  if (currentUser.isExpert) {
    container.innerHTML = `
      <div style="width:100%;padding:10px 12px;background:rgba(251,191,36,0.1);border-radius:12px;display:flex;align-items:center;gap:10px;font-size:13px;">
        <span class="expert-badge">‚úì ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç</span>
        <p style="margin:0;color:var(--text-secondary);">‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô Expert Chat ‡πÑ‡∏î‡πâ</p>
      </div>
      <button onclick="toggleExpertStatus()" style="width:100%;padding:10px;border:2px solid rgba(251,191,36,0.3);border-radius:12px;background:transparent;color:var(--text-primary);font-family:'Quicksand','Noto Sans Thai',sans-serif;font-size:14px;font-weight:600;cursor:pointer;margin-top:8px;">‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç</button>`;
  } else {
    const requested = allData.find(d => d.type === 'expert_request' && d.username === currentUser.username);
    if (requested && requested.expert_request_status === 'pending') {
      container.innerHTML = `
        <div style="width:100%;padding:10px 12px;background:rgba(167,139,250,0.1);border-radius:12px;display:flex;align-items:center;gap:10px;font-size:13px;">
          <span class="pending-badge">‚è≥ ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>
          <p style="margin:0;color:var(--text-secondary);">‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤</p>
        </div>`;
    } else {
      container.innerHTML = `<button onclick="toggleExpertStatus()" class="btn-gradient" style="width:100%;padding:10px;font-size:14px;">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç</button>`;
    }
  }
}

// ==================== COMMUNITY ====================
const defaultRooms = [
  { id: 'healing-hearts', name: 'üíó ‡∏´‡∏±‡∏ß‡πÉ‡∏à‡πÅ‡∏™‡∏ß‡∏á‡∏ö‡∏≥‡∏£‡∏∏‡∏á', desc: '‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡πà‡∏á‡∏õ‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏à‡∏¥‡∏ï‡πÉ‡∏à' },
  { id: 'uni-life', name: 'üéì ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤', desc: '‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢' }
];

function openCommunity() {
  showAppView('communityView');
  switchNav('navHome');
  renderCommunityRooms();
}

function renderCommunityRooms() {
  const container = document.getElementById('communityRooms');
  if (!container) return;
  const customRooms = allData.filter(d => d.type === 'community_room');
  const allRooms = [...defaultRooms, ...customRooms.map(r => ({ id: r.room_id, name: r.room_name, desc: '‡∏´‡πâ‡∏≠‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á' }))];

  container.innerHTML = allRooms.map(room => `
    <div class="feature-card" onclick="enterCommunityRoom('${room.id}','${(room.name || '').replace(/'/g, "\\'")}')">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <h3 style="margin:0;font-size:15px;color:var(--text-primary);">${room.name}</h3>
          <p style="margin:2px 0 0;font-size:12px;color:var(--text-secondary);">${room.desc || ''}</p>
        </div>
        <span style="font-size:18px;">‚Üí</span>
      </div>
    </div>
  `).join('');
}

async function createRoom() {
  const input = document.getElementById('newRoomName');
  const name = input.value.trim();
  if (!name) { showToast('‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á üìù'); return; }
  if (allData.filter(d => d.type === 'community_room').length >= 20) {
    showToast('‡∏ñ‡∏∂‡∏á‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß! üö´'); return;
  }
  input.value = '';
  if (window.dataSdk) {
    const result = await window.dataSdk.create({
      type: 'community_room',
      room_id: 'room-' + Date.now(),
      room_name: name,
      timestamp: new Date().toISOString()
    });
    if (result.isOk) showToast('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! üéâ');
    else showToast('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à üòî');
  }
}

function enterCommunityRoom(roomId, roomName) {
  currentCommunityRoom = roomId;
  document.getElementById('commRoomTitle').textContent = roomName;
  showAppView('communityChatView');
  renderCommChat();
}

function renderCommChat() {
  const container = document.getElementById('commChatMessages');
  if (!container || !currentCommunityRoom) return;
  const messages = allData.filter(d => d.type === 'comm_msg' && d.room_id === currentCommunityRoom)
    .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
  container.innerHTML = messages.length === 0
    ? '<p style="text-align:center;color:var(--text-secondary);font-size:13px;padding:20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏Å‡∏±‡∏ô! üí¨</p>'
    : messages.map(m => `
      <div class="chat-bubble ${m.sender === currentUser.username ? 'sent' : 'received'}">
        <div style="font-size:11px;font-weight:600;margin-bottom:2px;opacity:0.7;">${m.sender}</div>
        ${m.content}
      </div>`).join('');
  container.scrollTop = container.scrollHeight;
}

async function sendCommChat() {
  const input = document.getElementById('commChatInput');
  const msg = input.value.trim();
  if (!msg || !currentCommunityRoom) return;
  input.value = '';
  if (window.dataSdk) {
    const result = await window.dataSdk.create({
      type: 'comm_msg',
      room_id: currentCommunityRoom,
      content: msg,
      sender: currentUser.username,
      timestamp: new Date().toISOString()
    });
    if (!result.isOk) showToast('‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à üòî');
  }
}

// ==================== COZY SPACE (Posts) ====================
async function createPost() {
  const input = document.getElementById('postInput');
  const content = input.value.trim();
  if (!content) { showToast('‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ö‡∏≤‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô! ‚úçÔ∏è'); return; }
  input.value = '';
  if (window.dataSdk) {
    const result = await window.dataSdk.create({
      type: 'post',
      content,
      sender: currentUser.username,
      likes: 0,
      liked_by: '',
      timestamp: new Date().toISOString(),
      profile_emoji: currentUser.emoji
    });
    if (result.isOk) showToast('‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÅ‡∏•‡πâ‡∏ß! üå∏');
    else showToast('‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à üòî');
  }
}

function renderPosts() {
  const container = document.getElementById('postsFeed');
  if (!container) return;
  const posts = allData.filter(d => d.type === 'post').sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
  const replies = allData.filter(d => d.type === 'reply');

  container.innerHTML = posts.length === 0
    ? '<p style="text-align:center;color:var(--text-secondary);font-size:14px;padding:30px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏û‡∏™‡∏ï‡πå ‡∏ö‡∏≠‡∏Å‡πÄ‡∏•‡πà‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì! üí≠</p>'
    : posts.map(post => {
      const postReplies = replies.filter(r => r.parent_id === post.__backendId).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
      const likedUsers = (post.liked_by || '').split(',').filter(Boolean);
      const isLiked = likedUsers.includes(currentUser.username);
      const timeAgo = getTimeAgo(post.timestamp);

      return `<div class="post-card">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
          <div class="profile-avatar" style="width:34px;height:34px;font-size:16px;">${post.profile_emoji || 'üòä'}</div>
          <div>
            <span style="font-weight:600;font-size:14px;color:var(--text-primary);">${post.sender}</span>
            <span style="font-size:11px;color:var(--text-secondary);margin-left:8px;">${timeAgo}</span>
          </div>
        </div>
        <p style="margin:0 0 10px;font-size:14px;color:var(--text-primary);line-height:1.5;">${post.content}</p>
        <div style="display:flex;gap:16px;align-items:center;margin-bottom:8px;">
          <button onclick="toggleLike('${post.__backendId}')" style="background:none;border:none;cursor:pointer;display:flex;align-items:center;gap:4px;font-size:13px;color:${isLiked?'#ec4899':'var(--text-secondary)'};font-family:'Quicksand','Noto Sans Thai',sans-serif;">
            ${isLiked ? '‚ù§Ô∏è' : 'ü§ç'} ${post.likes || 0}
          </button>
          <button onclick="toggleReplyBox('${post.__backendId}')" style="background:none;border:none;cursor:pointer;font-size:13px;color:var(--text-secondary);font-family:'Quicksand','Noto Sans Thai',sans-serif;">
            üí¨ ${postReplies.length}
          </button>
        </div>
        ${postReplies.map(r => `
          <div style="margin-left:20px;padding:8px 12px;background:rgba(196,181,253,0.1);border-radius:10px;margin-bottom:6px;">
            <span style="font-weight:600;font-size:12px;color:var(--text-primary);">${r.sender}</span>
            <span style="font-size:11px;color:var(--text-secondary);margin-left:6px;">${getTimeAgo(r.timestamp)}</span>
            <p style="margin:4px 0 0;font-size:13px;color:var(--text-primary);">${r.content}</p>
          </div>
        `).join('')}
        <div id="replyBox-${post.__backendId}" style="display:none;margin-top:8px;">
          <div style="display:flex;gap:6px;">
            <label for="replyInput-${post.__backendId}" class="sr-only" style="position:absolute;width:1px;height:1px;overflow:hidden;">‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö</label>
            <input id="replyInput-${post.__backendId}" type="text" class="input-field" placeholder="‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö..." style="flex:1;padding:8px 12px;font-size:13px;font-family:'Quicksand','Noto Sans Thai',sans-serif;" onkeydown="if(event.key==='Enter'){event.preventDefault();sendReply('${post.__backendId}');}">
            <button onclick="sendReply('${post.__backendId}')" class="btn-gradient" style="padding:8px 12px;font-size:12px;">‡∏ï‡∏≠‡∏ö</button>
          </div>
        </div>
      </div>`;
    }).join('');
}

function toggleReplyBox(postId) {
  const box = document.getElementById('replyBox-' + postId);
  if (box) box.style.display = box.style.display === 'none' ? 'block' : 'none';
}

async function toggleLike(postId) {
  const post = allData.find(d => d.__backendId === postId);
  if (!post) return;
  const likedUsers = (post.liked_by || '').split(',').filter(Boolean);
  const isLiked = likedUsers.includes(currentUser.username);
  let newLiked, newCount;
  if (isLiked) {
    newLiked = likedUsers.filter(u => u !== currentUser.username).join(',');
    newCount = Math.max(0, (post.likes || 0) - 1);
  } else {
    likedUsers.push(currentUser.username);
    newLiked = likedUsers.join(',');
    newCount = (post.likes || 0) + 1;
    if (post.sender !== currentUser.username && window.dataSdk) {
      await window.dataSdk.create({
        type: 'notification',
        content: `${currentUser.username} ‡∏ñ‡∏π‡∏Å‡πÉ‡∏à‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‚ù§Ô∏è`,
        sender: currentUser.username,
        parent_id: postId,
        timestamp: new Date().toISOString()
      });
    }
  }
  if (window.dataSdk) {
    await window.dataSdk.update({ ...post, likes: newCount, liked_by: newLiked });
  }
}

async function sendReply(postId) {
  const input = document.getElementById('replyInput-' + postId);
  const content = input.value.trim();
  if (!content) return;
  input.value = '';
  if (window.dataSdk) {
    const result = await window.dataSdk.create({
      type: 'reply',
      parent_id: postId,
      content,
      sender: currentUser.username,
      timestamp: new Date().toISOString()
    });
    if (result.isOk) {
      const post = allData.find(d => d.__backendId === postId);
      if (post && post.sender !== currentUser.username) {
        await window.dataSdk.create({
          type: 'notification',
          content: `${currentUser.username} ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì üí¨`,
          sender: currentUser.username,
          parent_id: postId,
          timestamp: new Date().toISOString()
        });
      }
    }
  }
}

// ==================== NOTIFICATIONS ====================
function renderNotifications() {
  const container = document.getElementById('notificationsList');
  if (!container) return;
  const notis = allData.filter(d => d.type === 'notification').sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
  container.innerHTML = notis.length === 0
    ? '<p style="text-align:center;color:var(--text-secondary);font-size:14px;padding:40px 0;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô üåô</p>'
    : notis.map(n => `
      <div class="post-card" style="padding:12px;">
        <div style="display:flex;align-items:center;gap:10px;">
          <div style="width:8px;height:8px;border-radius:50%;background:#ec4899;flex-shrink:0;"></div>
          <div>
            <p style="margin:0;font-size:14px;color:var(--text-primary);">${n.content}</p>
            <span style="font-size:11px;color:var(--text-secondary);">${getTimeAgo(n.timestamp)}</span>
          </div>
        </div>
      </div>`).join('');
}

// ==================== MESSAGES ====================
function renderMessages() {
  const container = document.getElementById('messagesList');
  if (!container) return;
  const aiChats = allData.filter(d => d.type === 'chat_ai');
  const expertChats = allData.filter(d => d.type === 'chat_expert');
  const rooms = [];

  if (aiChats.length > 0) rooms.push({ name: 'ü§ñ ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤ AI', lastMsg: aiChats[aiChats.length - 1]?.content || '', action: 'openChatAI()' });
  if (expertChats.length > 0) rooms.push({ name: 'üë©‚Äç‚öïÔ∏è ‡πÅ‡∏ä‡∏ó‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç', lastMsg: expertChats[expertChats.length - 1]?.content || '', action: 'openExpertChat()' });

  const commRoomIds = [...new Set(allData.filter(d => d.type === 'comm_msg').map(d => d.room_id))];
  commRoomIds.forEach(rid => {
    const msgs = allData.filter(d => d.type === 'comm_msg' && d.room_id === rid);
    const room = defaultRooms.find(r => r.id === rid) || allData.find(d => d.type === 'community_room' && d.room_id === rid);
    const name = room ? (room.name || room.room_name) : rid;
    rooms.push({ name: `üë• ${name}`, lastMsg: msgs[msgs.length - 1]?.content || '', action: `enterCommunityRoom('${rid}','${(name || '').replace(/'/g, "\\'")}')`});
  });

  container.innerHTML = rooms.length === 0
    ? '<p style="text-align:center;color:var(--text-secondary);font-size:14px;padding:40px 0;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤ üí≠</p>'
    : rooms.map(r => `
      <div class="feature-card" onclick="${r.action}" style="padding:14px;">
        <h4 style="margin:0;font-size:15px;color:var(--text-primary);">${r.name}</h4>
        <p style="margin:4px 0 0;font-size:12px;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${r.lastMsg}</p>
      </div>`).join('');
}

// ==================== SENTIMENT / QUIZ ====================
const quizQuestions = [
  {
    q: "‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á 2 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤ ‡∏Ñ‡∏∏‡∏ì‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÄ‡∏®‡∏£‡πâ‡∏≤ ‡∏´‡∏î‡∏´‡∏π‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡πâ‡∏≠‡πÅ‡∏ó‡πâ‡∏ö‡πà‡∏≠‡∏¢‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô",
    opts: ["‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏¢", "‡∏ö‡πâ‡∏≤‡∏á‡∏ß‡∏±‡∏ô", "‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô", "‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô"],
    scores: [0, 1, 2, 3]
  },
  {
    q: "‡∏Ñ‡∏∏‡∏ì‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏Ç‡∏≤‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡∏ö‡πà‡∏≠‡∏¢‡πÑ‡∏´‡∏°",
    opts: ["‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏¢", "‡∏ö‡πâ‡∏≤‡∏á‡∏ß‡∏±‡∏ô", "‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô", "‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô"],
    scores: [0, 1, 2, 3]
  },
  {
    q: "‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡∏ô‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£",
    opts: ["‡∏î‡∏µ‡∏°‡∏≤‡∏Å", "‡∏î‡∏µ", "‡πÅ‡∏¢‡πà", "‡πÅ‡∏¢‡πà‡∏°‡∏≤‡∏Å"],
    scores: [0, 1, 2, 3]
  },
  {
    q: "‡∏Ñ‡∏∏‡∏ì‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏ß‡∏¥‡∏ï‡∏Å‡∏±‡∏á‡∏ß‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏´‡πà‡∏ß‡∏á‡πÉ‡∏à‡∏ö‡πà‡∏≠‡∏¢‡πÑ‡∏´‡∏°",
    opts: ["‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏¢", "‡∏ö‡πâ‡∏≤‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á", "‡∏ö‡πà‡∏≠‡∏¢", "‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡∏ï‡∏•‡∏≠‡∏î"],
    scores: [0, 1, 2, 3]
  },
  {
    q: "‡∏Ñ‡∏∏‡∏ì‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ô‡∏£‡∏≠‡∏ö‡∏ï‡∏±‡∏ß‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô",
    opts: ["‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏î‡∏µ‡∏°‡∏≤‡∏Å", "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏î‡∏µ", "‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÇ‡∏î‡∏î‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß‡∏ö‡πâ‡∏≤‡∏á", "‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÇ‡∏î‡∏î‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß‡∏°‡∏≤‡∏Å"],
    scores: [0, 1, 2, 3]
  },
  {
    q: "‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏î‡∏µ‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô",
    opts: ["‡∏î‡∏µ‡∏°‡∏≤‡∏Å", "‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏î‡∏µ", "‡∏¢‡∏≤‡∏Å‡∏ö‡πâ‡∏≤‡∏á", "‡∏¢‡∏≤‡∏Å‡∏°‡∏≤‡∏Å"],
    scores: [0, 1, 2, 3]
  },
  {
    q: "‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ö‡∏ö‡πà‡∏≠‡∏¢‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô",
    opts: ["‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô", "‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏•‡∏∞‡∏™‡∏≠‡∏á‡∏™‡∏≤‡∏°‡∏Ñ‡∏£‡∏±‡πâ‡∏á", "‡πÑ‡∏°‡πà‡∏ö‡πà‡∏≠‡∏¢", "‡πÅ‡∏ó‡∏ö‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏¢"],
    scores: [0, 1, 2, 3]
  },
  {
    q: "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£",
    opts: ["‡∏°‡∏µ‡∏û‡∏•‡∏±‡∏á‡∏™‡∏π‡∏á", "‡∏û‡∏•‡∏±‡∏á‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á", "‡∏û‡∏•‡∏±‡∏á‡∏ô‡πâ‡∏≠‡∏¢", "‡∏û‡∏•‡∏±‡∏á‡∏ï‡πà‡∏≥‡∏°‡∏≤‡∏Å"],
    scores: [0, 1, 2, 3]
  },
  {
    q: "‡∏Ñ‡∏∏‡∏ì‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏´‡∏ô‡∏±‡∏Å‡πÉ‡∏à‡∏à‡∏≤‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏ö‡πà‡∏≠‡∏¢‡πÑ‡∏´‡∏°",
    opts: ["‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏¢", "‡∏ö‡πâ‡∏≤‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á", "‡∏ö‡πà‡∏≠‡∏¢", "‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡∏ï‡∏•‡∏≠‡∏î"],
    scores: [0, 1, 2, 3]
  },
  {
    q: "‡∏Ñ‡∏∏‡∏ì‡∏´‡∏ß‡∏±‡∏á‡∏î‡∏µ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô",
    opts: ["‡∏´‡∏ß‡∏±‡∏á‡∏î‡∏µ‡∏°‡∏≤‡∏Å", "‡∏´‡∏ß‡∏±‡∏á‡∏î‡∏µ‡∏û‡∏≠‡∏™‡∏°‡∏Ñ‡∏ß‡∏£", "‡∏´‡∏ß‡∏±‡∏á‡∏î‡∏µ‡∏ô‡πâ‡∏≠‡∏¢", "‡∏´‡∏ß‡∏±‡∏á‡∏î‡∏µ‡πÅ‡∏ó‡∏ö‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏¢"],
    scores: [0, 1, 2, 3]
  }
];

let quizStep = 0;
let quizAnswers = [];

function startQuiz() {
  quizStep = 0;
  quizAnswers = [];
  showAppView('quizView');
  renderQuizStep();
}

function renderQuizStep() {
  const container = document.getElementById('quizContent');
  if (quizStep >= quizQuestions.length) {
    finishQuiz();
    return;
  }
  const q = quizQuestions[quizStep];
  container.innerHTML = `
    <div class="glass-card" style="padding:20px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <span style="font-size:13px;color:var(--text-secondary);">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà ${quizStep + 1} ‡∏à‡∏≤‡∏Å ${quizQuestions.length}</span>
        <div style="width:100px;height:6px;border-radius:3px;background:rgba(196,181,253,0.2);overflow:hidden;">
          <div style="width:${((quizStep + 1) / quizQuestions.length) * 100}%;height:100%;border-radius:3px;background:linear-gradient(90deg,#f9a8d4,#93c5fd);transition:width 0.3s;"></div>
        </div>
      </div>
      <p style="font-size:16px;color:var(--text-primary);font-weight:600;margin:0 0 16px;line-height:1.5;">${q.q}</p>
      <div style="display:flex;flex-direction:column;gap:8px;">
        ${q.opts.map((opt, i) => `
          <div class="quiz-option" id="qopt-${i}" onclick="selectQuizOption(${i})" style="font-family:'Quicksand','Noto Sans Thai',sans-serif;">${opt}</div>
        `).join('')}
      </div>
      <button id="quizNextBtn" class="btn-gradient" style="width:100%;padding:10px;font-size:14px;margin-top:16px;opacity:0.5;pointer-events:none;" onclick="nextQuizStep()">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</button>
    </div>`;
}

let selectedQuizOption = -1;

function selectQuizOption(idx) {
  selectedQuizOption = idx;
  document.querySelectorAll('.quiz-option').forEach((el, i) => {
    el.classList.toggle('selected', i === idx);
  });
  const btn = document.getElementById('quizNextBtn');
  btn.style.opacity = '1';
  btn.style.pointerEvents = 'auto';
}

function nextQuizStep() {
  if (selectedQuizOption < 0) return;
  quizAnswers.push(quizQuestions[quizStep].scores[selectedQuizOption]);
  selectedQuizOption = -1;
  quizStep++;
  renderQuizStep();
}

async function finishQuiz() {
  const totalScore = quizAnswers.reduce((a, b) => a + b, 0);
  const maxScore = quizQuestions.length * 3;
  const percentage = Math.round((totalScore / maxScore) * 100);

  const categories = {
    mood: Math.round(((3 - quizAnswers[0]) / 3) * 100),
    interest: Math.round(((3 - quizAnswers[1]) / 3) * 100),
    sleep: Math.round(((3 - quizAnswers[2]) / 3) * 100),
    anxiety: Math.round(((3 - quizAnswers[3]) / 3) * 100),
    connection: Math.round(((3 - quizAnswers[4]) / 3) * 100),
    stress: Math.round(((3 - quizAnswers[5]) / 3) * 100),
    enjoyment: Math.round(((3 - quizAnswers[6]) / 3) * 100),
    energy: Math.round(((3 - quizAnswers[7]) / 3) * 100),
    overwhelm: Math.round(((3 - quizAnswers[8]) / 3) * 100),
    hope: Math.round(((3 - quizAnswers[9]) / 3) * 100)
  };

  const wellbeing = 100 - percentage;
  let level, emoji, advice;
  if (wellbeing >= 80) { level = '‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°'; emoji = 'üåü'; advice = '‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏°‡∏≤‡∏Å ‡πÉ‡∏´‡πâ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏à‡∏¥‡∏ï‡∏ï‡πà‡∏≠‡πÑ‡∏õ'; }
  else if (wellbeing >= 60) { level = '‡∏î‡∏µ'; emoji = 'üòä'; advice = '‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏µ‡πÇ‡∏î‡∏¢‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≠‡∏ô‡πÅ‡∏≠‡∏•‡∏á'; }
  else if (wellbeing >= 40) { level = '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á'; emoji = 'üå§Ô∏è'; advice = '‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô ‡∏û‡∏π‡∏î‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤'; }
  else if (wellbeing >= 20) { level = '‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏à‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡πÉ‡∏à'; emoji = 'üíô'; advice = '‡∏î‡∏π‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡πà‡∏≤‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏¢‡∏≤‡∏Å‡∏•‡∏≥‡∏ö‡∏≤‡∏Å ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏¥‡∏î‡∏ñ‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç'; }
  else { level = '‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏î‡πà‡∏ß‡∏ô'; emoji = 'ü§ó'; advice = '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏à‡∏¥‡∏ï‡πÇ‡∏î‡∏¢‡∏î‡πà‡∏ß‡∏ô'; }

  if (window.dataSdk) {
    await window.dataSdk.create({
      type: 'sentiment',
      sentiment_score: wellbeing,
      sentiment_date: new Date().toISOString(),
      sender: currentUser.username,
      content: level
    });
  }

  const container = document.getElementById('quizContent');
  container.innerHTML = `
    <div class="glass-card" style="padding:24px;text-align:center;">
      <div style="font-size:48px;margin-bottom:12px;">${emoji}</div>
      <h3 style="margin:0 0 8px;font-size:22px;color:var(--text-primary);font-family:'Caveat',cursive;">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏à‡∏¥‡∏ï‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
      <div style="font-size:48px;font-weight:700;color:${wellbeing >= 60 ? '#10b981' : wellbeing >= 40 ? '#f59e0b' : '#ef4444'};margin:8px 0;">${wellbeing}%</div>
      <p style="font-size:16px;font-weight:600;color:var(--text-primary);margin:0 0 12px;">${level}</p>
      <p style="font-size:14px;color:var(--text-secondary);line-height:1.6;margin:0 0 20px;">${advice}</p>

      <div style="text-align:left;margin-bottom:20px;">
        <h4 style="margin:0 0 12px;font-size:14px;color:var(--text-primary);font-weight:600;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h4>
        <div style="display:flex;flex-direction:column;gap:10px;font-size:12px;">
          <div>
            <div style="display:flex;justify-content:space-between;margin-bottom:3px;">
              <span style="color:var(--text-primary);">‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå:</span>
              <span style="color:var(--text-secondary);">${categories.mood}%</span>
            </div>
            <div style="height:8px;border-radius:4px;background:rgba(196,181,253,0.2);overflow:hidden;">
              <div class="sentiment-bar" style="width:${categories.mood}%;background:linear-gradient(90deg,${categories.mood >= 60 ? '#10b981,#34d399' : categories.mood >= 40 ? '#f59e0b,#fbbf24' : '#ef4444,#f87171'});"></div>
            </div>
          </div>
          <div>
            <div style="display:flex;justify-content:space-between;margin-bottom:3px;">
              <span style="color:var(--text-primary);">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ô‡πÉ‡∏à:</span>
              <span style="color:var(--text-secondary);">${categories.interest}%</span>
            </div>
            <div style="height:8px;border-radius:4px;background:rgba(196,181,253,0.2);overflow:hidden;">
              <div class="sentiment-bar" style="width:${categories.interest}%;background:linear-gradient(90deg,${categories.interest >= 60 ? '#10b981,#34d399' : categories.interest >= 40 ? '#f59e0b,#fbbf24' : '#ef4444,#f87171'});"></div>
            </div>
          </div>
          <div>
            <div style="display:flex;justify-content:space-between;margin-bottom:3px;">
              <span style="color:var(--text-primary);">‡∏Å‡∏≤‡∏£‡∏ô‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏ö:</span>
              <span style="color:var(--text-secondary);">${categories.sleep}%</span>
            </div>
            <div style="height:8px;border-radius:4px;background:rgba(196,181,253,0.2);overflow:hidden;">
              <div class="sentiment-bar" style="width:${categories.sleep}%;background:linear-gradient(90deg,${categories.sleep >= 60 ? '#10b981,#34d399' : categories.sleep >= 40 ? '#f59e0b,#fbbf24' : '#ef4444,#f87171'});"></div>
            </div>
          </div>
          <div>
            <div style="display:flex;justify-content:space-between;margin-bottom:3px;">
              <span style="color:var(--text-primary);">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏±‡∏á‡∏ß‡∏•:</span>
              <span style="color:var(--text-secondary);">${categories.anxiety}%</span>
            </div>
            <div style="height:8px;border-radius:4px;background:rgba(196,181,253,0.2);overflow:hidden;">
              <div class="sentiment-bar" style="width:${categories.anxiety}%;background:linear-gradient(90deg,${categories.anxiety >= 60 ? '#10b981,#34d399' : categories.anxiety >= 40 ? '#f59e0b,#fbbf24' : '#ef4444,#f87171'});"></div>
            </div>
          </div>
          <div>
            <div style="display:flex;justify-content:space-between;margin-bottom:3px;">
              <span style="color:var(--text-primary);">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠:</span>
              <span style="color:var(--text-secondary);">${categories.connection}%</span>
            </div>
            <div style="height:8px;border-radius:4px;background:rgba(196,181,253,0.2);overflow:hidden;">
              <div class="sentiment-bar" style="width:${categories.connection}%;background:linear-gradient(90deg,${categories.connection >= 60 ? '#10b981,#34d399' : categories.connection >= 40 ? '#f59e0b,#fbbf24' : '#ef4444,#f87171'});"></div>
            </div>
          </div>
        </div>
      </div>

      <button onclick="showAppView('profileView');switchNav('navProfile')" class="btn-gradient" style="width:100%;padding:10px;font-size:14px;">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</button>
    </div>`;
}

function renderSentiment() {
  const container = document.getElementById('sentimentBars');
  if (!container) return;
  const sentiments = allData.filter(d => d.type === 'sentiment').sort((a, b) => new Date(a.sentiment_date) - new Date(b.sentiment_date));
  if (sentiments.length === 0) {
    container.innerHTML = '<p style="text-align:center;color:var(--text-secondary);font-size:13px;">‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå!</p>';
    return;
  }
  const recent = sentiments.slice(-5);
  container.innerHTML = `
    <div style="display:flex;align-items:flex-end;gap:8px;height:100px;justify-content:center;margin-bottom:8px;">
      ${recent.map(s => {
        const h = Math.max(10, s.sentiment_score || 0);
        const color = h >= 60 ? '#10b981' : h >= 40 ? '#f59e0b' : '#ef4444';
        const d = new Date(s.sentiment_date);
        const label = `${d.getDate()}/${d.getMonth() + 1}`;
        return `<div style="display:flex;flex-direction:column;align-items:center;gap:4px;">
          <span style="font-size:10px;color:var(--text-secondary);">${s.sentiment_score}%</span>
          <div style="width:28px;height:${h}%;background:${color};border-radius:6px 6px 0 0;transition:height 0.5s;"></div>
          <span style="font-size:9px;color:var(--text-secondary);">${label}</span>
        </div>`;
      }).join('')}
    </div>
    <p style="text-align:center;font-size:12px;color:var(--text-secondary);margin:0;">‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${recent[recent.length - 1].content} (${recent[recent.length - 1].sentiment_score}%)</p>`;
}

// ==================== HELPERS ====================
function getTimeAgo(timestamp) {
  if (!timestamp) return '';
  const diff = Date.now() - new Date(timestamp).getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà';
  if (mins < 60) return `${mins}‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return `${hrs}‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
  const days = Math.floor(hrs / 24);
  return `${days}‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
}
</script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9ccbfe7a62b64493',t:'MTc3MDg5ODM0NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
